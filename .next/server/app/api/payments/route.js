"use strict";(()=>{var e={};e.id=649,e.ids=[649],e.modules={30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},85477:e=>{e.exports=require("punycode")},12781:e=>{e.exports=require("stream")},57310:e=>{e.exports=require("url")},59796:e=>{e.exports=require("zlib")},18e3:(e,t,r)=>{r.r(t),r.d(t,{headerHooks:()=>h,originalPathname:()=>q,patchFetch:()=>Z,requestAsyncStorage:()=>f,routeModule:()=>_,serverHooks:()=>y,staticGenerationAsyncStorage:()=>g,staticGenerationBailout:()=>b});var n={};r.r(n),r.d(n,{GET:()=>l,POST:()=>c});var a=r(95419),s=r(69108),i=r(99678),o=r(78070),u=r(32409),m=r(65256);let d=(0,u.eI)("https://placeholder.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY),p=m.Ry({student_id:m.Z_().uuid("Valid student ID is required"),paid_amount:m.Rx().positive("Paid amount must be positive"),payment_method:m.Km(["cash","card","upi","net_banking","cheque","bank_transfer"]),payment_status:m.Km(["pending","completed","failed","cancelled"]).default("pending"),fee_item_ids:m.IX(m.Z_().uuid()).min(1,"At least one fee item is required"),notes:m.Z_().optional(),institution_id:m.Z_().uuid("Valid institution ID is required")});async function l(e){try{let{searchParams:t}=new URL(e.url),r=t.get("institution_id"),n=parseInt(t.get("page")||"1"),a=parseInt(t.get("limit")||"10"),s=t.get("search")||"",i=t.get("status")||"",u=t.get("method")||"",m=t.get("date_from")||"",p=t.get("date_to")||"";if(!r)return o.Z.json({error:"Institution ID is required"},{status:400});let l=(n-1)*a,c=d.from("payments").select(`
        id,
        receipt_number,
        paid_amount,
        payment_method,
        payment_status,
        payment_date,
        notes,
        students!inner(
          first_name,
          last_name,
          admission_number
        ),
        classes!inner(
          name,
          section
        )
      `,{count:"exact"}).eq("institution_id",r);s&&(c=c.or(`receipt_number.ilike.%${s}%,students.first_name.ilike.%${s}%,students.last_name.ilike.%${s}%,students.admission_number.ilike.%${s}%`)),i&&(c=c.eq("payment_status",i)),u&&(c=c.eq("payment_method",u)),m&&(c=c.gte("payment_date",m)),p&&(c=c.lte("payment_date",p));let{data:_,error:f,count:g}=await c.order("payment_date",{ascending:!1}).range(l,l+a-1);if(f)return console.error("Error fetching payments:",f),o.Z.json({error:"Failed to fetch payments"},{status:500});return o.Z.json({payments:_||[],pagination:{page:n,limit:a,total:g||0,totalPages:Math.ceil((g||0)/a)}})}catch(e){return console.error("Error in GET /api/payments:",e),o.Z.json({error:"Internal server error"},{status:500})}}async function c(e){try{let t=await e.json(),r=p.safeParse(t);if(!r.success)return o.Z.json({error:"Invalid request data",details:r.error.errors},{status:400});let{student_id:n,paid_amount:a,payment_method:s,payment_status:i,fee_item_ids:u,notes:m,institution_id:l}=r.data,{data:c}=await d.from("students").select("id, first_name, last_name, admission_number").eq("id",n).eq("institution_id",l).single();if(!c)return o.Z.json({error:"Student not found"},{status:404});let{data:_,error:f}=await d.from("student_fee_items").select(`
        id,
        amount,
        outstanding_amount,
        fee_items(name)
      `).in("id",u).eq("student_fees.students.id",n);if(f)return console.error("Error fetching fee items:",f),o.Z.json({error:"Failed to fetch fee items"},{status:500});if(!_||_.length!==u.length)return o.Z.json({error:"One or more fee items not found"},{status:400});let g=_.reduce((e,t)=>e+Number(t.outstanding_amount),0);if(a>g)return o.Z.json({error:"Paid amount cannot exceed outstanding amount"},{status:400});let y=`RCP${Date.now()}${Math.random().toString(36).substr(2,5).toUpperCase()}`,{data:h,error:b}=await d.from("payments").insert({institution_id:l,student_id:n,receipt_number:y,total_amount:g,paid_amount:a,payment_method:s,payment_status:i,notes:m,collected_by:e.headers.get("user-id")}).select().single();if(b)return console.error("Error creating payment:",b),o.Z.json({error:"Failed to create payment"},{status:500});let q=_.map(e=>({payment_id:h.id,student_fee_item_id:e.id,amount:Math.min(Number(e.outstanding_amount),Number(e.outstanding_amount)/g*a)})),{error:Z}=await d.from("payment_fee_items").insert(q);if(Z)return console.error("Error creating payment fee items:",Z),await d.from("payments").delete().eq("id",h.id),o.Z.json({error:"Failed to create payment fee items"},{status:500});for(let e of _){let t=Math.min(Number(e.outstanding_amount),Number(e.outstanding_amount)/g*a),r=Number(e.amount)-Number(e.outstanding_amount)+t,{error:n}=await d.from("student_fee_items").update({paid_amount:r,status:r>=Number(e.amount)?"paid":"partial"}).eq("id",e.id);n&&console.error("Error updating fee item:",n)}let{error:j}=await d.from("receipts").insert({payment_id:h.id,receipt_number:y});return j&&console.error("Error creating receipt:",j),o.Z.json({message:"Payment created successfully",payment:h,receipt_number:y},{status:201})}catch(e){return console.error("Error in POST /api/payments:",e),o.Z.json({error:"Internal server error"},{status:500})}}let _=new a.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/payments/route",pathname:"/api/payments",filename:"route",bundlePath:"app/api/payments/route"},resolvedPagePath:"C:\\Users\\sg13c\\fee-management-saas\\app\\api\\payments\\route.ts",nextConfigOutput:"",userland:n}),{requestAsyncStorage:f,staticGenerationAsyncStorage:g,serverHooks:y,headerHooks:h,staticGenerationBailout:b}=_,q="/api/payments/route";function Z(){return(0,i.patchFetch)({serverHooks:y,staticGenerationAsyncStorage:g})}}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),n=t.X(0,[638,720,256],()=>r(18e3));module.exports=n})();