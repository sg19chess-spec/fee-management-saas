"use strict";(()=>{var e={};e.id=687,e.ids=[687],e.modules={30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},85477:e=>{e.exports=require("punycode")},12781:e=>{e.exports=require("stream")},57310:e=>{e.exports=require("url")},59796:e=>{e.exports=require("zlib")},12851:(e,t,r)=>{r.r(t),r.d(t,{headerHooks:()=>g,originalPathname:()=>v,patchFetch:()=>x,requestAsyncStorage:()=>f,routeModule:()=>c,serverHooks:()=>y,staticGenerationAsyncStorage:()=>h,staticGenerationBailout:()=>q});var n={};r.r(n),r.d(n,{GET:()=>l,PUT:()=>_});var s=r(95419),a=r(69108),i=r(99678),o=r(78070),u=r(32409),d=r(65256);let m=(0,u.eI)("https://placeholder.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY),p=d.Ry({payment_status:d.Km(["pending","completed","failed","refunded"]).optional(),reference_number:d.Z_().optional(),notes:d.Z_().optional(),discount_amount:d.Rx().min(0).optional(),discount_reason:d.Z_().optional()});async function l(e,{params:t}){try{if(!e.headers.get("authorization"))return o.Z.json({error:"Authorization header required"},{status:401});let r=e.headers.get("x-institution-id");if(!r)return o.Z.json({error:"Institution ID required"},{status:400});let{data:n,error:s}=await m.from("fee_payments").select(`
        *,
        students!inner(
          first_name,
          last_name,
          admission_number,
          classes!inner(name, section)
        )
      `).eq("id",t.id).eq("institution_id",r).single();if(s){if("PGRST116"===s.code)return o.Z.json({error:"Payment not found"},{status:404});throw s}let{data:a,error:i}=await m.from("payment_fee_items").select(`
        id,
        paid_amount,
        fee_items!inner(name),
        fee_plans!inner(name)
      `).eq("payment_id",t.id).eq("institution_id",r);if(i)throw i;let u={...n,student_name:`${n.students.first_name} ${n.students.last_name}`,student_admission:n.students.admission_number,student_class:`${n.students.classes.name} ${n.students.classes.section}`,fee_items:a?.map(e=>({id:e.id,fee_item_name:e.fee_items.name,paid_amount:e.paid_amount,fee_plan_name:e.fee_plans.name}))||[]};return o.Z.json(u)}catch(e){return console.error("Error fetching payment:",e),o.Z.json({error:"Internal server error"},{status:500})}}async function _(e,{params:t}){try{if(!e.headers.get("authorization"))return o.Z.json({error:"Authorization header required"},{status:401});let r=e.headers.get("x-institution-id");if(!r)return o.Z.json({error:"Institution ID required"},{status:400});let n=await e.json(),s=p.safeParse(n);if(!s.success)return o.Z.json({error:"Validation failed",details:s.error.errors},{status:400});let{payment_status:a,reference_number:i,notes:u,discount_amount:d,discount_reason:l}=s.data,{data:_,error:c}=await m.from("fee_payments").select("id, total_amount, paid_amount").eq("id",t.id).eq("institution_id",r).single();if(c){if("PGRST116"===c.code)return o.Z.json({error:"Payment not found"},{status:404});throw c}let f={};void 0!==a&&(f.payment_status=a),void 0!==i&&(f.reference_number=i),void 0!==u&&(f.notes=u),void 0!==d&&(f.discount_amount=d),void 0!==l&&(f.discount_reason=l),f.updated_at=new Date().toISOString();let{data:h,error:y}=await m.from("fee_payments").update(f).eq("id",t.id).eq("institution_id",r).select().single();if(y)throw y;return"completed"===a&&console.log(`Payment ${t.id} marked as completed`),await m.from("audit_logs").insert({table_name:"fee_payments",record_id:t.id,action:"UPDATE",old_values:_,new_values:h,institution_id:r,user_id:e.headers.get("x-user-id")||"system"}),o.Z.json({message:"Payment updated successfully",payment:h})}catch(e){return console.error("Error updating payment:",e),o.Z.json({error:"Internal server error"},{status:500})}}let c=new s.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/payments/[id]/route",pathname:"/api/payments/[id]",filename:"route",bundlePath:"app/api/payments/[id]/route"},resolvedPagePath:"C:\\Users\\sg13c\\fee-management-saas\\app\\api\\payments\\[id]\\route.ts",nextConfigOutput:"",userland:n}),{requestAsyncStorage:f,staticGenerationAsyncStorage:h,serverHooks:y,headerHooks:g,staticGenerationBailout:q}=c,v="/api/payments/[id]/route";function x(){return(0,i.patchFetch)({serverHooks:y,staticGenerationAsyncStorage:h})}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),n=t.X(0,[638,720,256],()=>r(12851));module.exports=n})();