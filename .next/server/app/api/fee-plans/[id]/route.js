"use strict";(()=>{var e={};e.id=334,e.ids=[334],e.modules={30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},85477:e=>{e.exports=require("punycode")},12781:e=>{e.exports=require("stream")},57310:e=>{e.exports=require("url")},59796:e=>{e.exports=require("zlib")},21792:(e,t,i)=>{i.r(t),i.d(t,{headerHooks:()=>w,originalPathname:()=>x,patchFetch:()=>j,requestAsyncStorage:()=>h,routeModule:()=>c,serverHooks:()=>g,staticGenerationAsyncStorage:()=>q,staticGenerationBailout:()=>Z});var r={};i.r(r),i.d(r,{DELETE:()=>m,GET:()=>f,PUT:()=>_});var a=i(95419),n=i(69108),o=i(99678),s=i(78070),d=i(32409),u=i(65256);let l=(0,d.eI)("https://placeholder.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY),p=u.Ry({name:u.Z_().min(1,"Fee plan name is required").max(100).optional(),description:u.Z_().optional(),academic_year:u.Z_().min(1,"Academic year is required").optional(),total_amount:u.Rx().min(0,"Total amount must be positive").optional(),discount_percentage:u.Rx().min(0).max(100).optional(),discount_amount:u.Rx().min(0).optional(),discount_reason:u.Z_().optional(),status:u.Km(["active","inactive"]).optional(),fee_items:u.IX(u.Ry({id:u.Z_().optional(),name:u.Z_().min(1,"Fee item name is required"),amount:u.Rx().min(0,"Amount must be positive"),description:u.Z_().optional(),due_date:u.Z_().min(1,"Due date is required"),is_optional:u.O7().default(!1)})).optional()});async function f(e,{params:t}){try{if(!e.headers.get("authorization"))return s.Z.json({error:"Authorization header required"},{status:401});let i=e.headers.get("x-institution-id");if(!i)return s.Z.json({error:"Institution ID required"},{status:400});let{data:r,error:a}=await l.from("fee_plans").select("*").eq("id",t.id).eq("institution_id",i).single();if(a){if("PGRST116"===a.code)return s.Z.json({error:"Fee plan not found"},{status:404});throw a}let{data:n,error:o}=await l.from("fee_items").select("*").eq("fee_plan_id",t.id).eq("institution_id",i).order("created_at");if(o)throw o;let d={...r,fee_items:n||[]};return s.Z.json(d)}catch(e){return console.error("Error fetching fee plan:",e),s.Z.json({error:"Internal server error"},{status:500})}}async function _(e,{params:t}){try{if(!e.headers.get("authorization"))return s.Z.json({error:"Authorization header required"},{status:401});let i=e.headers.get("x-institution-id");if(!i)return s.Z.json({error:"Institution ID required"},{status:400});let r=await e.json(),a=p.safeParse(r);if(!a.success)return s.Z.json({error:"Validation failed",details:a.error.errors},{status:400});let{fee_items:n,...o}=a.data,{data:d,error:u}=await l.from("fee_plans").select("*").eq("id",t.id).eq("institution_id",i).single();if(u){if("PGRST116"===u.code)return s.Z.json({error:"Fee plan not found"},{status:404});throw u}let f={...o,updated_at:new Date().toISOString()},{data:_,error:m}=await l.from("fee_plans").update(f).eq("id",t.id).eq("institution_id",i).select().single();if(m)throw m;if(n&&n.length>0){let{data:e}=await l.from("fee_items").select("id").eq("fee_plan_id",t.id).eq("institution_id",i),r=e?.map(e=>e.id)||[];for(let e of n)e.id&&r.includes(e.id)?await l.from("fee_items").update({name:e.name,amount:e.amount,description:e.description,due_date:e.due_date,is_optional:e.is_optional,updated_at:new Date().toISOString()}).eq("id",e.id).eq("institution_id",i):await l.from("fee_items").insert({fee_plan_id:t.id,name:e.name,amount:e.amount,description:e.description,due_date:e.due_date,is_optional:e.is_optional,institution_id:i});let a=n.filter(e=>e.id).map(e=>e.id),o=r.filter(e=>!a.includes(e));o.length>0&&await l.from("fee_items").delete().in("id",o).eq("institution_id",i)}return await l.from("audit_logs").insert({table_name:"fee_plans",record_id:t.id,action:"UPDATE",old_values:d,new_values:_,institution_id:i,user_id:e.headers.get("x-user-id")||"system"}),s.Z.json({message:"Fee plan updated successfully",fee_plan:_})}catch(e){return console.error("Error updating fee plan:",e),s.Z.json({error:"Internal server error"},{status:500})}}async function m(e,{params:t}){try{if(!e.headers.get("authorization"))return s.Z.json({error:"Authorization header required"},{status:401});let i=e.headers.get("x-institution-id");if(!i)return s.Z.json({error:"Institution ID required"},{status:400});let{data:r,error:a}=await l.from("fee_plans").select("*").eq("id",t.id).eq("institution_id",i).single();if(a){if("PGRST116"===a.code)return s.Z.json({error:"Fee plan not found"},{status:404});throw a}let{data:n,error:o}=await l.from("fee_plan_assignments").select("id").eq("fee_plan_id",t.id).eq("institution_id",i).limit(1);if(o)throw o;if(n&&n.length>0)return s.Z.json({error:"Cannot delete fee plan that is assigned to students"},{status:400});let{data:d,error:u}=await l.from("fee_payments").select("id").eq("fee_plan_id",t.id).eq("institution_id",i).limit(1);if(u)throw u;if(d&&d.length>0)return s.Z.json({error:"Cannot delete fee plan that has associated payments"},{status:400});await l.from("fee_items").delete().eq("fee_plan_id",t.id).eq("institution_id",i);let{error:p}=await l.from("fee_plans").delete().eq("id",t.id).eq("institution_id",i);if(p)throw p;return await l.from("audit_logs").insert({table_name:"fee_plans",record_id:t.id,action:"DELETE",old_values:r,new_values:null,institution_id:i,user_id:e.headers.get("x-user-id")||"system"}),s.Z.json({message:"Fee plan deleted successfully"})}catch(e){return console.error("Error deleting fee plan:",e),s.Z.json({error:"Internal server error"},{status:500})}}let c=new a.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/fee-plans/[id]/route",pathname:"/api/fee-plans/[id]",filename:"route",bundlePath:"app/api/fee-plans/[id]/route"},resolvedPagePath:"C:\\Users\\sg13c\\fee-management-saas\\app\\api\\fee-plans\\[id]\\route.ts",nextConfigOutput:"",userland:r}),{requestAsyncStorage:h,staticGenerationAsyncStorage:q,serverHooks:g,headerHooks:w,staticGenerationBailout:Z}=c,x="/api/fee-plans/[id]/route";function j(){return(0,o.patchFetch)({serverHooks:g,staticGenerationAsyncStorage:q})}}};var t=require("../../../../webpack-runtime.js");t.C(e);var i=e=>t(t.s=e),r=t.X(0,[638,720,256],()=>i(21792));module.exports=r})();