"use strict";(()=>{var e={};e.id=46,e.ids=[46],e.modules={30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},85477:e=>{e.exports=require("punycode")},12781:e=>{e.exports=require("stream")},57310:e=>{e.exports=require("url")},59796:e=>{e.exports=require("zlib")},40743:(e,t,s)=>{s.r(t),s.d(t,{headerHooks:()=>w,originalPathname:()=>b,patchFetch:()=>I,requestAsyncStorage:()=>f,routeModule:()=>h,serverHooks:()=>_,staticGenerationAsyncStorage:()=>g,staticGenerationBailout:()=>y});var r={};s.r(r),s.d(r,{GET:()=>m,POST:()=>p});var n=s(95419),a=s(69108),i=s(99678),o=s(78070),u=s(8234),l=s(2563),d=s(65256);let c=d.Ry({studentFeeItemIds:d.IX(d.Z_().uuid()),templateId:d.Z_().uuid(),type:d.Km(["single","bulk"]).default("single")});async function p(e){try{let t;let s=(0,u.fU)(),{data:{user:r},error:n}=await s.auth.getUser();if(n||!r)return o.Z.json({error:"Unauthorized"},{status:401});let{data:a,error:i}=await s.from("users").select("*, institutions!inner(*)").eq("id",r.id).single();if(i||!a)return o.Z.json({error:"User profile not found"},{status:404});if(!["school_admin","accountant"].includes(a.role))return o.Z.json({error:"Insufficient permissions"},{status:403});let d=a.institution_id,p=await e.json(),m=c.safeParse(p);if(!m.success)return o.Z.json({error:"Invalid request data",details:m.error.errors},{status:400});let{studentFeeItemIds:h,templateId:f,type:g}=m.data,{data:_,error:w}=await s.from("reminder_templates").select("*").eq("id",f).eq("institution_id",d).single();if(w||!_)return o.Z.json({error:"Template not found"},{status:404});let{data:y,error:b}=await s.from("student_fee_items").select(`
        id,
        student_fees!inner(
          students!inner(institution_id)
        )
      `).in("id",h);if(b)return o.Z.json({error:"Error fetching fee items"},{status:500});let I=y?.filter(e=>e.student_fees.students.institution_id!==d);if(I&&I.length>0)return o.Z.json({error:"Some fee items do not belong to your institution"},{status:403});if("bulk"===g)t=await l.Z.sendBulkReminders(d,h,f);else{if(1!==h.length)return o.Z.json({error:"Single reminder requires exactly one fee item ID"},{status:400});let{data:e,error:r}=await s.from("student_fee_items").select(`
          student_fees!inner(student_id)
        `).eq("id",h[0]).single();if(r||!e)return o.Z.json({error:"Fee item not found"},{status:404});t={success:(t=await l.Z.sendPaymentReminder(d,e.student_fees.student_id,h[0],f)).success,sent:t.success?1:0,failed:t.success?0:1,errors:t.error?[t.error]:[]}}if(t.success)return o.Z.json({success:!0,sent:t.sent,failed:t.failed,errors:t.errors,message:`Successfully sent ${t.sent} reminder(s)`});return o.Z.json({success:!1,sent:t.sent,failed:t.failed,errors:t.errors},{status:500})}catch(e){return console.error("Error sending reminders:",e),o.Z.json({error:"Internal server error"},{status:500})}}async function m(e){try{let t=(0,u.fU)(),{data:{user:s},error:r}=await t.auth.getUser();if(r||!s)return o.Z.json({error:"Unauthorized"},{status:401});let{data:n,error:a}=await t.from("users").select("*, institutions!inner(*)").eq("id",s.id).single();if(a||!n)return o.Z.json({error:"User profile not found"},{status:404});if(!["school_admin","accountant"].includes(n.role))return o.Z.json({error:"Insufficient permissions"},{status:403});let i=n.institution_id,{searchParams:l}=new URL(e.url),d=parseInt(l.get("page")||"1"),c=parseInt(l.get("limit")||"20"),p=l.get("status"),m=l.get("type"),h=t.from("reminder_logs").select(`
        *,
        students!inner(
          users!inner(first_name, last_name),
          classes(name, section)
        ),
        reminder_templates(name)
      `).eq("institution_id",i).order("created_at",{ascending:!1});p&&(h=h.eq("status",p)),m&&(h=h.eq("reminder_type",m));let f=(d-1)*c;h=h.range(f,f+c-1);let{data:g,error:_,count:w}=await h;if(_)return o.Z.json({error:"Error fetching reminder logs"},{status:500});return o.Z.json({success:!0,data:g,pagination:{page:d,limit:c,total:w||0,pages:Math.ceil((w||0)/c)}})}catch(e){return console.error("Error fetching reminder logs:",e),o.Z.json({error:"Internal server error"},{status:500})}}let h=new n.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/whatsapp/reminders/route",pathname:"/api/whatsapp/reminders",filename:"route",bundlePath:"app/api/whatsapp/reminders/route"},resolvedPagePath:"C:\\Users\\sg13c\\fee-management-saas\\app\\api\\whatsapp\\reminders\\route.ts",nextConfigOutput:"",userland:r}),{requestAsyncStorage:f,staticGenerationAsyncStorage:g,serverHooks:_,headerHooks:w,staticGenerationBailout:y}=h,b="/api/whatsapp/reminders/route";function I(){return(0,i.patchFetch)({serverHooks:_,staticGenerationAsyncStorage:g})}},8234:(e,t,s)=>{s.d(t,{fU:()=>n});var r=s(32409);(0,r.eI)("https://placeholder.supabase.co","placeholder-anon-key",{auth:{autoRefreshToken:!0,persistSession:!0,detectSessionInUrl:!0},realtime:{params:{eventsPerSecond:10}}});let n=()=>{let e=process.env.SUPABASE_SERVICE_ROLE_KEY;return(0,r.eI)("https://placeholder.supabase.co",e,{auth:{autoRefreshToken:!1,persistSession:!1}})}},2563:(e,t,s)=>{s.d(t,{Z:()=>a});var r=s(32409);class n{constructor(){this.supabase=(0,r.eI)("https://placeholder.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY)}async getInstitutionConfig(e){try{let{data:t,error:s}=await this.supabase.from("institutions").select(`
          whatsapp_api_key,
          whatsapp_endpoint_url,
          whatsapp_phone_number_id,
          whatsapp_waba_id,
          whatsapp_business_phone,
          whatsapp_webhook_secret
        `).eq("id",e).single();if(s||!t)return console.error("Error fetching institution WhatsApp config:",s),null;return{apiKey:t.whatsapp_api_key,endpointUrl:t.whatsapp_endpoint_url,phoneNumberId:t.whatsapp_phone_number_id,wabaId:t.whatsapp_waba_id,businessPhone:t.whatsapp_business_phone,webhookSecret:t.whatsapp_webhook_secret}}catch(e){return console.error("Error in getInstitutionConfig:",e),null}}async sendTextMessage(e,t,s){try{let r=await this.getInstitutionConfig(e);if(!r)return{success:!1,error:"Institution WhatsApp configuration not found"};let n=this.formatPhoneNumber(t),a=await fetch(`${r.endpointUrl}/${r.phoneNumberId}/messages`,{method:"POST",headers:{Authorization:`Bearer ${r.apiKey}`,"Content-Type":"application/json"},body:JSON.stringify({messaging_product:"whatsapp",to:n,type:"text",text:{body:s}})}),i=await a.json();if(!a.ok)return console.error("WhatsApp API error:",i),{success:!1,error:"Failed to send WhatsApp message"};return await this.logReminderMessage(e,t,s,"whatsapp","sent"),{success:!0,messageId:i.messages?.[0]?.id}}catch(e){return console.error("Error sending WhatsApp message:",e),{success:!1,error:"Internal server error"}}}async sendTemplateMessage(e,t,s,r){try{let n=await this.getInstitutionConfig(e);if(!n)return{success:!1,error:"Institution WhatsApp configuration not found"};let a=this.formatPhoneNumber(t),i=Object.entries(r).map(([e,t])=>({type:"body",parameters:[{type:"text",text:t}]})),o=await fetch(`${n.endpointUrl}/${n.phoneNumberId}/messages`,{method:"POST",headers:{Authorization:`Bearer ${n.apiKey}`,"Content-Type":"application/json"},body:JSON.stringify({messaging_product:"whatsapp",to:a,type:"template",template:{name:s,language:{code:"en"},components:i}})}),u=await o.json();if(!o.ok)return console.error("WhatsApp API error:",u),{success:!1,error:"Failed to send WhatsApp template message"};return await this.logReminderMessage(e,t,`Template: ${s} with parameters: ${JSON.stringify(r)}`,"whatsapp","sent"),{success:!0,messageId:u.messages?.[0]?.id}}catch(e){return console.error("Error sending WhatsApp template message:",e),{success:!1,error:"Internal server error"}}}async sendPaymentReminder(e,t,s,r){try{let{data:n,error:a}=await this.supabase.from("students").select(`
          *,
          users!inner(first_name, last_name, phone),
          classes(name, section)
        `).eq("id",t).single();if(a||!n)return{success:!1,error:"Student not found"};let{data:i,error:o}=await this.supabase.from("student_fee_items").select(`
          *,
          fee_items(name, amount, due_date)
        `).eq("id",s).single();if(o||!i)return{success:!1,error:"Fee item not found"};let{data:u,error:l}=await this.supabase.from("reminder_templates").select("*").eq("id",r).single();if(l||!u)return{success:!1,error:"Template not found"};let d=`${n.users.first_name} ${n.users.last_name}`,c=`${n.users.first_name} ${n.users.last_name}`,p=`${n.classes.name} ${n.classes.section}`,m=i.fee_items.amount,h=new Date(i.fee_items.due_date).toLocaleDateString("en-IN"),f=u.message_template;f=(f=(f=(f=(f=f.replace("{{parent_name}}",d)).replace("{{student_name}}",c)).replace("{{class}}",p)).replace("{{amount}}",m.toString())).replace("{{due_date}}",h);let g=await this.sendTextMessage(e,n.users.phone,f);return g.success&&await this.logReminderMessage(e,n.users.phone,f,"whatsapp","sent",t,r),g}catch(e){return console.error("Error sending payment reminder:",e),{success:!1,error:"Internal server error"}}}async sendPaymentConfirmation(e,t,s){try{let{data:r,error:n}=await this.supabase.from("payments").select(`
          *,
          students!inner(
            users!inner(first_name, last_name, phone),
            classes(name, section)
          ),
          receipts(receipt_number)
        `).eq("id",t).single();if(n||!r)return{success:!1,error:"Payment not found"};let{data:a,error:i}=await this.supabase.from("reminder_templates").select("*").eq("id",s).single();if(i||!a)return{success:!1,error:"Template not found"};let o=`${r.students.users.first_name} ${r.students.users.last_name}`,u=`${r.students.users.first_name} ${r.students.users.last_name}`,l=r.paid_amount,d=r.receipts.receipt_number,c=a.message_template;c=(c=(c=(c=c.replace("{{parent_name}}",o)).replace("{{student_name}}",u)).replace("{{amount}}",l.toString())).replace("{{receipt_number}}",d);let p=await this.sendTextMessage(e,r.students.users.phone,c);return p.success&&await this.logReminderMessage(e,r.students.users.phone,c,"whatsapp","sent",r.student_id,s),p}catch(e){return console.error("Error sending payment confirmation:",e),{success:!1,error:"Internal server error"}}}async sendBulkReminders(e,t,s){let r={success:!0,sent:0,failed:0,errors:[]};for(let n of t)try{let t=await this.sendPaymentReminder(e,"",n,s);t.success?r.sent++:(r.failed++,r.errors.push(`Fee item ${n}: ${t.error}`))}catch(e){r.failed++,r.errors.push(`Fee item ${n}: ${e}`)}return r}verifyWebhookSignature(e,t,s){return!0}async handleWebhook(e,t,s){try{let r=await this.getInstitutionConfig(e);if(!r?.webhookSecret){console.error("No webhook secret configured for institution");return}if(!this.verifyWebhookSignature(JSON.stringify(t),s,r.webhookSecret)){console.error("Invalid webhook signature");return}if(t.entry&&t.entry.length>0){for(let s of t.entry)if(s.changes&&s.changes.length>0){for(let t of s.changes)if(t.value&&t.value.messages)for(let s of t.value.messages)await this.processIncomingMessage(e,s)}}}catch(e){console.error("Error handling webhook:",e)}}async processIncomingMessage(e,t){try{await this.logReminderMessage(e,t.from,t.text?.body||"Non-text message","whatsapp","received"),"text"===t.type&&await this.handleTextMessage(e,t)}catch(e){console.error("Error processing incoming message:",e)}}async handleTextMessage(e,t){let s=t.text.body.toLowerCase(),r=t.from;s.includes("fee")||s.includes("payment")?await this.sendTextMessage(e,r,"Thank you for your inquiry. Please contact the school office for fee-related queries."):(s.includes("receipt")||s.includes("bill"))&&await this.sendTextMessage(e,r,"Please provide your student ID or admission number to get your receipt details.")}formatPhoneNumber(e){let t=e.replace(/\D/g,"");return t.startsWith("91")||10!==t.length||(t="91"+t),t}async logReminderMessage(e,t,s,r,n,a,i){try{await this.supabase.from("reminder_logs").insert({institution_id:e,student_id:a,template_id:i,reminder_type:r,recipient_whatsapp:t,message_content:s,status:n,sent_at:"sent"===n?new Date().toISOString():null})}catch(e){console.error("Error logging reminder message:",e)}}}let a=new n}};var t=require("../../../../webpack-runtime.js");t.C(e);var s=e=>t(t.s=e),r=t.X(0,[638,720,256],()=>s(40743));module.exports=r})();