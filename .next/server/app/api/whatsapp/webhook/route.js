"use strict";(()=>{var e={};e.id=975,e.ids=[975],e.modules={30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},85477:e=>{e.exports=require("punycode")},12781:e=>{e.exports=require("stream")},57310:e=>{e.exports=require("url")},59796:e=>{e.exports=require("zlib")},14723:(e,t,s)=>{s.r(t),s.d(t,{headerHooks:()=>g,originalPathname:()=>w,patchFetch:()=>_,requestAsyncStorage:()=>h,routeModule:()=>l,serverHooks:()=>m,staticGenerationAsyncStorage:()=>d,staticGenerationBailout:()=>f});var r={};s.r(r),s.d(r,{GET:()=>p,POST:()=>c});var a=s(95419),n=s(69108),o=s(99678),i=s(78070),u=s(2563);async function p(e){try{let{searchParams:t}=new URL(e.url),s=t.get("hub.mode"),r=t.get("hub.verify_token"),a=t.get("hub.challenge"),n=e.nextUrl.pathname.split("/"),o=n[n.length-2];if(!o)return i.Z.json({error:"Institution ID not found"},{status:400});if("subscribe"===s&&r)return console.log(`Webhook verified for institution: ${o}`),new i.Z(a,{status:200});return i.Z.json({error:"Invalid webhook verification"},{status:403})}catch(e){return console.error("Error in webhook verification:",e),i.Z.json({error:"Internal server error"},{status:500})}}async function c(e){try{let t=e.nextUrl.pathname.split("/"),s=t[t.length-2];if(!s)return i.Z.json({error:"Institution ID not found"},{status:400});let r=e.headers.get("x-hub-signature-256")||"",a=await e.json();return await u.Z.handleWebhook(s,a,r),i.Z.json({success:!0})}catch(e){return console.error("Error handling webhook:",e),i.Z.json({error:"Internal server error"},{status:500})}}let l=new a.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/whatsapp/webhook/route",pathname:"/api/whatsapp/webhook",filename:"route",bundlePath:"app/api/whatsapp/webhook/route"},resolvedPagePath:"C:\\Users\\sg13c\\fee-management-saas\\app\\api\\whatsapp\\webhook\\route.ts",nextConfigOutput:"",userland:r}),{requestAsyncStorage:h,staticGenerationAsyncStorage:d,serverHooks:m,headerHooks:g,staticGenerationBailout:f}=l,w="/api/whatsapp/webhook/route";function _(){return(0,o.patchFetch)({serverHooks:m,staticGenerationAsyncStorage:d})}},2563:(e,t,s)=>{s.d(t,{Z:()=>n});var r=s(32409);class a{constructor(){this.supabase=(0,r.eI)("https://placeholder.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY)}async getInstitutionConfig(e){try{let{data:t,error:s}=await this.supabase.from("institutions").select(`
          whatsapp_api_key,
          whatsapp_endpoint_url,
          whatsapp_phone_number_id,
          whatsapp_waba_id,
          whatsapp_business_phone,
          whatsapp_webhook_secret
        `).eq("id",e).single();if(s||!t)return console.error("Error fetching institution WhatsApp config:",s),null;return{apiKey:t.whatsapp_api_key,endpointUrl:t.whatsapp_endpoint_url,phoneNumberId:t.whatsapp_phone_number_id,wabaId:t.whatsapp_waba_id,businessPhone:t.whatsapp_business_phone,webhookSecret:t.whatsapp_webhook_secret}}catch(e){return console.error("Error in getInstitutionConfig:",e),null}}async sendTextMessage(e,t,s){try{let r=await this.getInstitutionConfig(e);if(!r)return{success:!1,error:"Institution WhatsApp configuration not found"};let a=this.formatPhoneNumber(t),n=await fetch(`${r.endpointUrl}/${r.phoneNumberId}/messages`,{method:"POST",headers:{Authorization:`Bearer ${r.apiKey}`,"Content-Type":"application/json"},body:JSON.stringify({messaging_product:"whatsapp",to:a,type:"text",text:{body:s}})}),o=await n.json();if(!n.ok)return console.error("WhatsApp API error:",o),{success:!1,error:"Failed to send WhatsApp message"};return await this.logReminderMessage(e,t,s,"whatsapp","sent"),{success:!0,messageId:o.messages?.[0]?.id}}catch(e){return console.error("Error sending WhatsApp message:",e),{success:!1,error:"Internal server error"}}}async sendTemplateMessage(e,t,s,r){try{let a=await this.getInstitutionConfig(e);if(!a)return{success:!1,error:"Institution WhatsApp configuration not found"};let n=this.formatPhoneNumber(t),o=Object.entries(r).map(([e,t])=>({type:"body",parameters:[{type:"text",text:t}]})),i=await fetch(`${a.endpointUrl}/${a.phoneNumberId}/messages`,{method:"POST",headers:{Authorization:`Bearer ${a.apiKey}`,"Content-Type":"application/json"},body:JSON.stringify({messaging_product:"whatsapp",to:n,type:"template",template:{name:s,language:{code:"en"},components:o}})}),u=await i.json();if(!i.ok)return console.error("WhatsApp API error:",u),{success:!1,error:"Failed to send WhatsApp template message"};return await this.logReminderMessage(e,t,`Template: ${s} with parameters: ${JSON.stringify(r)}`,"whatsapp","sent"),{success:!0,messageId:u.messages?.[0]?.id}}catch(e){return console.error("Error sending WhatsApp template message:",e),{success:!1,error:"Internal server error"}}}async sendPaymentReminder(e,t,s,r){try{let{data:a,error:n}=await this.supabase.from("students").select(`
          *,
          users!inner(first_name, last_name, phone),
          classes(name, section)
        `).eq("id",t).single();if(n||!a)return{success:!1,error:"Student not found"};let{data:o,error:i}=await this.supabase.from("student_fee_items").select(`
          *,
          fee_items(name, amount, due_date)
        `).eq("id",s).single();if(i||!o)return{success:!1,error:"Fee item not found"};let{data:u,error:p}=await this.supabase.from("reminder_templates").select("*").eq("id",r).single();if(p||!u)return{success:!1,error:"Template not found"};let c=`${a.users.first_name} ${a.users.last_name}`,l=`${a.users.first_name} ${a.users.last_name}`,h=`${a.classes.name} ${a.classes.section}`,d=o.fee_items.amount,m=new Date(o.fee_items.due_date).toLocaleDateString("en-IN"),g=u.message_template;g=(g=(g=(g=(g=g.replace("{{parent_name}}",c)).replace("{{student_name}}",l)).replace("{{class}}",h)).replace("{{amount}}",d.toString())).replace("{{due_date}}",m);let f=await this.sendTextMessage(e,a.users.phone,g);return f.success&&await this.logReminderMessage(e,a.users.phone,g,"whatsapp","sent",t,r),f}catch(e){return console.error("Error sending payment reminder:",e),{success:!1,error:"Internal server error"}}}async sendPaymentConfirmation(e,t,s){try{let{data:r,error:a}=await this.supabase.from("payments").select(`
          *,
          students!inner(
            users!inner(first_name, last_name, phone),
            classes(name, section)
          ),
          receipts(receipt_number)
        `).eq("id",t).single();if(a||!r)return{success:!1,error:"Payment not found"};let{data:n,error:o}=await this.supabase.from("reminder_templates").select("*").eq("id",s).single();if(o||!n)return{success:!1,error:"Template not found"};let i=`${r.students.users.first_name} ${r.students.users.last_name}`,u=`${r.students.users.first_name} ${r.students.users.last_name}`,p=r.paid_amount,c=r.receipts.receipt_number,l=n.message_template;l=(l=(l=(l=l.replace("{{parent_name}}",i)).replace("{{student_name}}",u)).replace("{{amount}}",p.toString())).replace("{{receipt_number}}",c);let h=await this.sendTextMessage(e,r.students.users.phone,l);return h.success&&await this.logReminderMessage(e,r.students.users.phone,l,"whatsapp","sent",r.student_id,s),h}catch(e){return console.error("Error sending payment confirmation:",e),{success:!1,error:"Internal server error"}}}async sendBulkReminders(e,t,s){let r={success:!0,sent:0,failed:0,errors:[]};for(let a of t)try{let t=await this.sendPaymentReminder(e,"",a,s);t.success?r.sent++:(r.failed++,r.errors.push(`Fee item ${a}: ${t.error}`))}catch(e){r.failed++,r.errors.push(`Fee item ${a}: ${e}`)}return r}verifyWebhookSignature(e,t,s){return!0}async handleWebhook(e,t,s){try{let r=await this.getInstitutionConfig(e);if(!r?.webhookSecret){console.error("No webhook secret configured for institution");return}if(!this.verifyWebhookSignature(JSON.stringify(t),s,r.webhookSecret)){console.error("Invalid webhook signature");return}if(t.entry&&t.entry.length>0){for(let s of t.entry)if(s.changes&&s.changes.length>0){for(let t of s.changes)if(t.value&&t.value.messages)for(let s of t.value.messages)await this.processIncomingMessage(e,s)}}}catch(e){console.error("Error handling webhook:",e)}}async processIncomingMessage(e,t){try{await this.logReminderMessage(e,t.from,t.text?.body||"Non-text message","whatsapp","received"),"text"===t.type&&await this.handleTextMessage(e,t)}catch(e){console.error("Error processing incoming message:",e)}}async handleTextMessage(e,t){let s=t.text.body.toLowerCase(),r=t.from;s.includes("fee")||s.includes("payment")?await this.sendTextMessage(e,r,"Thank you for your inquiry. Please contact the school office for fee-related queries."):(s.includes("receipt")||s.includes("bill"))&&await this.sendTextMessage(e,r,"Please provide your student ID or admission number to get your receipt details.")}formatPhoneNumber(e){let t=e.replace(/\D/g,"");return t.startsWith("91")||10!==t.length||(t="91"+t),t}async logReminderMessage(e,t,s,r,a,n,o){try{await this.supabase.from("reminder_logs").insert({institution_id:e,student_id:n,template_id:o,reminder_type:r,recipient_whatsapp:t,message_content:s,status:a,sent_at:"sent"===a?new Date().toISOString():null})}catch(e){console.error("Error logging reminder message:",e)}}}let n=new a}};var t=require("../../../../webpack-runtime.js");t.C(e);var s=e=>t(t.s=e),r=t.X(0,[638,720],()=>s(14723));module.exports=r})();