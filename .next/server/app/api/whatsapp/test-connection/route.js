"use strict";(()=>{var e={};e.id=540,e.ids=[540],e.modules={30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},85477:e=>{e.exports=require("punycode")},12781:e=>{e.exports=require("stream")},57310:e=>{e.exports=require("url")},59796:e=>{e.exports=require("zlib")},80876:(e,t,s)=>{s.r(t),s.d(t,{headerHooks:()=>_,originalPathname:()=>y,patchFetch:()=>b,requestAsyncStorage:()=>m,routeModule:()=>h,serverHooks:()=>f,staticGenerationAsyncStorage:()=>g,staticGenerationBailout:()=>w});var r={};s.r(r),s.d(r,{POST:()=>d});var n=s(95419),a=s(69108),o=s(99678),i=s(78070),u=s(8234),p=s(2563),c=s(65256);let l=c.Ry({institutionId:c.Z_().uuid()});async function d(e){try{let t=(0,u.fU)(),{data:{user:s},error:r}=await t.auth.getUser();if(r||!s)return i.Z.json({error:"Unauthorized"},{status:401});let{data:n,error:a}=await t.from("users").select("*, institutions!inner(*)").eq("id",s.id).single();if(a||!n)return i.Z.json({error:"User profile not found"},{status:404});if(!["school_admin","accountant"].includes(n.role))return i.Z.json({error:"Insufficient permissions"},{status:403});let o=await e.json(),c=l.safeParse(o);if(!c.success)return i.Z.json({error:"Invalid request data",details:c.error.errors},{status:400});let{institutionId:d}=c.data;if(n.institution_id!==d)return i.Z.json({error:"Access denied to this institution"},{status:403});let{data:h,error:m}=await t.from("institutions").select(`
        whatsapp_api_key,
        whatsapp_endpoint_url,
        whatsapp_phone_number_id,
        whatsapp_business_phone
      `).eq("id",d).single();if(m||!h)return i.Z.json({error:"Institution not found"},{status:404});if(!h.whatsapp_api_key||!h.whatsapp_phone_number_id)return i.Z.json({error:"WhatsApp Business API not configured. Please configure your WhatsApp settings first."},{status:400});try{let e=await p.Z.getInstitutionConfig(d);if(!e)return i.Z.json({error:"Failed to get WhatsApp configuration"},{status:500});let t=await fetch(`${e.endpointUrl}/${e.phoneNumberId}`,{method:"GET",headers:{Authorization:`Bearer ${e.apiKey}`,"Content-Type":"application/json"}});if(!t.ok){let e=await t.json();return i.Z.json({error:`WhatsApp API test failed: ${e.error?.message||"Unknown error"}`},{status:400})}let s=await t.json();return i.Z.json({success:!0,message:"WhatsApp Business API connection successful!",phoneNumber:s.verified_name||"Unknown",businessPhone:h.whatsapp_business_phone})}catch(e){return console.error("WhatsApp API test error:",e),i.Z.json({error:"Failed to connect to WhatsApp Business API. Please check your configuration."},{status:500})}}catch(e){return console.error("Error testing WhatsApp connection:",e),i.Z.json({error:"Internal server error"},{status:500})}}let h=new n.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/whatsapp/test-connection/route",pathname:"/api/whatsapp/test-connection",filename:"route",bundlePath:"app/api/whatsapp/test-connection/route"},resolvedPagePath:"C:\\Users\\sg13c\\fee-management-saas\\app\\api\\whatsapp\\test-connection\\route.ts",nextConfigOutput:"",userland:r}),{requestAsyncStorage:m,staticGenerationAsyncStorage:g,serverHooks:f,headerHooks:_,staticGenerationBailout:w}=h,y="/api/whatsapp/test-connection/route";function b(){return(0,o.patchFetch)({serverHooks:f,staticGenerationAsyncStorage:g})}},8234:(e,t,s)=>{s.d(t,{fU:()=>n});var r=s(32409);(0,r.eI)("https://placeholder.supabase.co","placeholder-anon-key",{auth:{autoRefreshToken:!0,persistSession:!0,detectSessionInUrl:!0},realtime:{params:{eventsPerSecond:10}}});let n=()=>{let e=process.env.SUPABASE_SERVICE_ROLE_KEY;return(0,r.eI)("https://placeholder.supabase.co",e,{auth:{autoRefreshToken:!1,persistSession:!1}})}},2563:(e,t,s)=>{s.d(t,{Z:()=>a});var r=s(32409);class n{constructor(){this.supabase=(0,r.eI)("https://placeholder.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY)}async getInstitutionConfig(e){try{let{data:t,error:s}=await this.supabase.from("institutions").select(`
          whatsapp_api_key,
          whatsapp_endpoint_url,
          whatsapp_phone_number_id,
          whatsapp_waba_id,
          whatsapp_business_phone,
          whatsapp_webhook_secret
        `).eq("id",e).single();if(s||!t)return console.error("Error fetching institution WhatsApp config:",s),null;return{apiKey:t.whatsapp_api_key,endpointUrl:t.whatsapp_endpoint_url,phoneNumberId:t.whatsapp_phone_number_id,wabaId:t.whatsapp_waba_id,businessPhone:t.whatsapp_business_phone,webhookSecret:t.whatsapp_webhook_secret}}catch(e){return console.error("Error in getInstitutionConfig:",e),null}}async sendTextMessage(e,t,s){try{let r=await this.getInstitutionConfig(e);if(!r)return{success:!1,error:"Institution WhatsApp configuration not found"};let n=this.formatPhoneNumber(t),a=await fetch(`${r.endpointUrl}/${r.phoneNumberId}/messages`,{method:"POST",headers:{Authorization:`Bearer ${r.apiKey}`,"Content-Type":"application/json"},body:JSON.stringify({messaging_product:"whatsapp",to:n,type:"text",text:{body:s}})}),o=await a.json();if(!a.ok)return console.error("WhatsApp API error:",o),{success:!1,error:"Failed to send WhatsApp message"};return await this.logReminderMessage(e,t,s,"whatsapp","sent"),{success:!0,messageId:o.messages?.[0]?.id}}catch(e){return console.error("Error sending WhatsApp message:",e),{success:!1,error:"Internal server error"}}}async sendTemplateMessage(e,t,s,r){try{let n=await this.getInstitutionConfig(e);if(!n)return{success:!1,error:"Institution WhatsApp configuration not found"};let a=this.formatPhoneNumber(t),o=Object.entries(r).map(([e,t])=>({type:"body",parameters:[{type:"text",text:t}]})),i=await fetch(`${n.endpointUrl}/${n.phoneNumberId}/messages`,{method:"POST",headers:{Authorization:`Bearer ${n.apiKey}`,"Content-Type":"application/json"},body:JSON.stringify({messaging_product:"whatsapp",to:a,type:"template",template:{name:s,language:{code:"en"},components:o}})}),u=await i.json();if(!i.ok)return console.error("WhatsApp API error:",u),{success:!1,error:"Failed to send WhatsApp template message"};return await this.logReminderMessage(e,t,`Template: ${s} with parameters: ${JSON.stringify(r)}`,"whatsapp","sent"),{success:!0,messageId:u.messages?.[0]?.id}}catch(e){return console.error("Error sending WhatsApp template message:",e),{success:!1,error:"Internal server error"}}}async sendPaymentReminder(e,t,s,r){try{let{data:n,error:a}=await this.supabase.from("students").select(`
          *,
          users!inner(first_name, last_name, phone),
          classes(name, section)
        `).eq("id",t).single();if(a||!n)return{success:!1,error:"Student not found"};let{data:o,error:i}=await this.supabase.from("student_fee_items").select(`
          *,
          fee_items(name, amount, due_date)
        `).eq("id",s).single();if(i||!o)return{success:!1,error:"Fee item not found"};let{data:u,error:p}=await this.supabase.from("reminder_templates").select("*").eq("id",r).single();if(p||!u)return{success:!1,error:"Template not found"};let c=`${n.users.first_name} ${n.users.last_name}`,l=`${n.users.first_name} ${n.users.last_name}`,d=`${n.classes.name} ${n.classes.section}`,h=o.fee_items.amount,m=new Date(o.fee_items.due_date).toLocaleDateString("en-IN"),g=u.message_template;g=(g=(g=(g=(g=g.replace("{{parent_name}}",c)).replace("{{student_name}}",l)).replace("{{class}}",d)).replace("{{amount}}",h.toString())).replace("{{due_date}}",m);let f=await this.sendTextMessage(e,n.users.phone,g);return f.success&&await this.logReminderMessage(e,n.users.phone,g,"whatsapp","sent",t,r),f}catch(e){return console.error("Error sending payment reminder:",e),{success:!1,error:"Internal server error"}}}async sendPaymentConfirmation(e,t,s){try{let{data:r,error:n}=await this.supabase.from("payments").select(`
          *,
          students!inner(
            users!inner(first_name, last_name, phone),
            classes(name, section)
          ),
          receipts(receipt_number)
        `).eq("id",t).single();if(n||!r)return{success:!1,error:"Payment not found"};let{data:a,error:o}=await this.supabase.from("reminder_templates").select("*").eq("id",s).single();if(o||!a)return{success:!1,error:"Template not found"};let i=`${r.students.users.first_name} ${r.students.users.last_name}`,u=`${r.students.users.first_name} ${r.students.users.last_name}`,p=r.paid_amount,c=r.receipts.receipt_number,l=a.message_template;l=(l=(l=(l=l.replace("{{parent_name}}",i)).replace("{{student_name}}",u)).replace("{{amount}}",p.toString())).replace("{{receipt_number}}",c);let d=await this.sendTextMessage(e,r.students.users.phone,l);return d.success&&await this.logReminderMessage(e,r.students.users.phone,l,"whatsapp","sent",r.student_id,s),d}catch(e){return console.error("Error sending payment confirmation:",e),{success:!1,error:"Internal server error"}}}async sendBulkReminders(e,t,s){let r={success:!0,sent:0,failed:0,errors:[]};for(let n of t)try{let t=await this.sendPaymentReminder(e,"",n,s);t.success?r.sent++:(r.failed++,r.errors.push(`Fee item ${n}: ${t.error}`))}catch(e){r.failed++,r.errors.push(`Fee item ${n}: ${e}`)}return r}verifyWebhookSignature(e,t,s){return!0}async handleWebhook(e,t,s){try{let r=await this.getInstitutionConfig(e);if(!r?.webhookSecret){console.error("No webhook secret configured for institution");return}if(!this.verifyWebhookSignature(JSON.stringify(t),s,r.webhookSecret)){console.error("Invalid webhook signature");return}if(t.entry&&t.entry.length>0){for(let s of t.entry)if(s.changes&&s.changes.length>0){for(let t of s.changes)if(t.value&&t.value.messages)for(let s of t.value.messages)await this.processIncomingMessage(e,s)}}}catch(e){console.error("Error handling webhook:",e)}}async processIncomingMessage(e,t){try{await this.logReminderMessage(e,t.from,t.text?.body||"Non-text message","whatsapp","received"),"text"===t.type&&await this.handleTextMessage(e,t)}catch(e){console.error("Error processing incoming message:",e)}}async handleTextMessage(e,t){let s=t.text.body.toLowerCase(),r=t.from;s.includes("fee")||s.includes("payment")?await this.sendTextMessage(e,r,"Thank you for your inquiry. Please contact the school office for fee-related queries."):(s.includes("receipt")||s.includes("bill"))&&await this.sendTextMessage(e,r,"Please provide your student ID or admission number to get your receipt details.")}formatPhoneNumber(e){let t=e.replace(/\D/g,"");return t.startsWith("91")||10!==t.length||(t="91"+t),t}async logReminderMessage(e,t,s,r,n,a,o){try{await this.supabase.from("reminder_logs").insert({institution_id:e,student_id:a,template_id:o,reminder_type:r,recipient_whatsapp:t,message_content:s,status:n,sent_at:"sent"===n?new Date().toISOString():null})}catch(e){console.error("Error logging reminder message:",e)}}}let a=new n}};var t=require("../../../../webpack-runtime.js");t.C(e);var s=e=>t(t.s=e),r=t.X(0,[638,720,256],()=>s(80876));module.exports=r})();