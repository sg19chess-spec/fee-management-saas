"use strict";(()=>{var e={};e.id=824,e.ids=[824],e.modules={30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},85477:e=>{e.exports=require("punycode")},12781:e=>{e.exports=require("stream")},57310:e=>{e.exports=require("url")},59796:e=>{e.exports=require("zlib")},46139:(e,s,t)=>{t.r(s),t.d(s,{headerHooks:()=>_,originalPathname:()=>y,patchFetch:()=>b,requestAsyncStorage:()=>h,routeModule:()=>m,serverHooks:()=>f,staticGenerationAsyncStorage:()=>g,staticGenerationBailout:()=>w});var r={};t.r(r),t.d(r,{POST:()=>d});var a=t(95419),n=t(69108),o=t(99678),i=t(78070),u=t(8234),p=t(2563),c=t(65256);let l=c.Ry({phoneNumber:c.Z_().min(10).max(15),message:c.Z_().min(1).max(1e3),templateId:c.Z_().uuid().optional(),parameters:c.IM(c.Z_()).optional()});async function d(e){try{let s;let t=(0,u.fU)(),{data:{user:r},error:a}=await t.auth.getUser();if(a||!r)return i.Z.json({error:"Unauthorized"},{status:401});let{data:n,error:o}=await t.from("users").select("*, institutions!inner(*)").eq("id",r.id).single();if(o||!n)return i.Z.json({error:"User profile not found"},{status:404});if(!["school_admin","accountant"].includes(n.role))return i.Z.json({error:"Insufficient permissions"},{status:403});let c=n.institution_id,d=await e.json(),m=l.safeParse(d);if(!m.success)return i.Z.json({error:"Invalid request data",details:m.error.errors},{status:400});let{phoneNumber:h,message:g,templateId:f,parameters:_}=m.data;if((s=f&&_?await p.Z.sendTemplateMessage(c,h,f,_):await p.Z.sendTextMessage(c,h,g)).success)return i.Z.json({success:!0,messageId:s.messageId,message:"WhatsApp message sent successfully"});return i.Z.json({success:!1,error:s.error},{status:500})}catch(e){return console.error("Error sending WhatsApp message:",e),i.Z.json({error:"Internal server error"},{status:500})}}let m=new a.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/whatsapp/send/route",pathname:"/api/whatsapp/send",filename:"route",bundlePath:"app/api/whatsapp/send/route"},resolvedPagePath:"C:\\Users\\sg13c\\fee-management-saas\\app\\api\\whatsapp\\send\\route.ts",nextConfigOutput:"",userland:r}),{requestAsyncStorage:h,staticGenerationAsyncStorage:g,serverHooks:f,headerHooks:_,staticGenerationBailout:w}=m,y="/api/whatsapp/send/route";function b(){return(0,o.patchFetch)({serverHooks:f,staticGenerationAsyncStorage:g})}},8234:(e,s,t)=>{t.d(s,{fU:()=>a});var r=t(32409);(0,r.eI)("https://placeholder.supabase.co","placeholder-anon-key",{auth:{autoRefreshToken:!0,persistSession:!0,detectSessionInUrl:!0},realtime:{params:{eventsPerSecond:10}}});let a=()=>{let e=process.env.SUPABASE_SERVICE_ROLE_KEY;return(0,r.eI)("https://placeholder.supabase.co",e,{auth:{autoRefreshToken:!1,persistSession:!1}})}},2563:(e,s,t)=>{t.d(s,{Z:()=>n});var r=t(32409);class a{constructor(){this.supabase=(0,r.eI)("https://placeholder.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY)}async getInstitutionConfig(e){try{let{data:s,error:t}=await this.supabase.from("institutions").select(`
          whatsapp_api_key,
          whatsapp_endpoint_url,
          whatsapp_phone_number_id,
          whatsapp_waba_id,
          whatsapp_business_phone,
          whatsapp_webhook_secret
        `).eq("id",e).single();if(t||!s)return console.error("Error fetching institution WhatsApp config:",t),null;return{apiKey:s.whatsapp_api_key,endpointUrl:s.whatsapp_endpoint_url,phoneNumberId:s.whatsapp_phone_number_id,wabaId:s.whatsapp_waba_id,businessPhone:s.whatsapp_business_phone,webhookSecret:s.whatsapp_webhook_secret}}catch(e){return console.error("Error in getInstitutionConfig:",e),null}}async sendTextMessage(e,s,t){try{let r=await this.getInstitutionConfig(e);if(!r)return{success:!1,error:"Institution WhatsApp configuration not found"};let a=this.formatPhoneNumber(s),n=await fetch(`${r.endpointUrl}/${r.phoneNumberId}/messages`,{method:"POST",headers:{Authorization:`Bearer ${r.apiKey}`,"Content-Type":"application/json"},body:JSON.stringify({messaging_product:"whatsapp",to:a,type:"text",text:{body:t}})}),o=await n.json();if(!n.ok)return console.error("WhatsApp API error:",o),{success:!1,error:"Failed to send WhatsApp message"};return await this.logReminderMessage(e,s,t,"whatsapp","sent"),{success:!0,messageId:o.messages?.[0]?.id}}catch(e){return console.error("Error sending WhatsApp message:",e),{success:!1,error:"Internal server error"}}}async sendTemplateMessage(e,s,t,r){try{let a=await this.getInstitutionConfig(e);if(!a)return{success:!1,error:"Institution WhatsApp configuration not found"};let n=this.formatPhoneNumber(s),o=Object.entries(r).map(([e,s])=>({type:"body",parameters:[{type:"text",text:s}]})),i=await fetch(`${a.endpointUrl}/${a.phoneNumberId}/messages`,{method:"POST",headers:{Authorization:`Bearer ${a.apiKey}`,"Content-Type":"application/json"},body:JSON.stringify({messaging_product:"whatsapp",to:n,type:"template",template:{name:t,language:{code:"en"},components:o}})}),u=await i.json();if(!i.ok)return console.error("WhatsApp API error:",u),{success:!1,error:"Failed to send WhatsApp template message"};return await this.logReminderMessage(e,s,`Template: ${t} with parameters: ${JSON.stringify(r)}`,"whatsapp","sent"),{success:!0,messageId:u.messages?.[0]?.id}}catch(e){return console.error("Error sending WhatsApp template message:",e),{success:!1,error:"Internal server error"}}}async sendPaymentReminder(e,s,t,r){try{let{data:a,error:n}=await this.supabase.from("students").select(`
          *,
          users!inner(first_name, last_name, phone),
          classes(name, section)
        `).eq("id",s).single();if(n||!a)return{success:!1,error:"Student not found"};let{data:o,error:i}=await this.supabase.from("student_fee_items").select(`
          *,
          fee_items(name, amount, due_date)
        `).eq("id",t).single();if(i||!o)return{success:!1,error:"Fee item not found"};let{data:u,error:p}=await this.supabase.from("reminder_templates").select("*").eq("id",r).single();if(p||!u)return{success:!1,error:"Template not found"};let c=`${a.users.first_name} ${a.users.last_name}`,l=`${a.users.first_name} ${a.users.last_name}`,d=`${a.classes.name} ${a.classes.section}`,m=o.fee_items.amount,h=new Date(o.fee_items.due_date).toLocaleDateString("en-IN"),g=u.message_template;g=(g=(g=(g=(g=g.replace("{{parent_name}}",c)).replace("{{student_name}}",l)).replace("{{class}}",d)).replace("{{amount}}",m.toString())).replace("{{due_date}}",h);let f=await this.sendTextMessage(e,a.users.phone,g);return f.success&&await this.logReminderMessage(e,a.users.phone,g,"whatsapp","sent",s,r),f}catch(e){return console.error("Error sending payment reminder:",e),{success:!1,error:"Internal server error"}}}async sendPaymentConfirmation(e,s,t){try{let{data:r,error:a}=await this.supabase.from("payments").select(`
          *,
          students!inner(
            users!inner(first_name, last_name, phone),
            classes(name, section)
          ),
          receipts(receipt_number)
        `).eq("id",s).single();if(a||!r)return{success:!1,error:"Payment not found"};let{data:n,error:o}=await this.supabase.from("reminder_templates").select("*").eq("id",t).single();if(o||!n)return{success:!1,error:"Template not found"};let i=`${r.students.users.first_name} ${r.students.users.last_name}`,u=`${r.students.users.first_name} ${r.students.users.last_name}`,p=r.paid_amount,c=r.receipts.receipt_number,l=n.message_template;l=(l=(l=(l=l.replace("{{parent_name}}",i)).replace("{{student_name}}",u)).replace("{{amount}}",p.toString())).replace("{{receipt_number}}",c);let d=await this.sendTextMessage(e,r.students.users.phone,l);return d.success&&await this.logReminderMessage(e,r.students.users.phone,l,"whatsapp","sent",r.student_id,t),d}catch(e){return console.error("Error sending payment confirmation:",e),{success:!1,error:"Internal server error"}}}async sendBulkReminders(e,s,t){let r={success:!0,sent:0,failed:0,errors:[]};for(let a of s)try{let s=await this.sendPaymentReminder(e,"",a,t);s.success?r.sent++:(r.failed++,r.errors.push(`Fee item ${a}: ${s.error}`))}catch(e){r.failed++,r.errors.push(`Fee item ${a}: ${e}`)}return r}verifyWebhookSignature(e,s,t){return!0}async handleWebhook(e,s,t){try{let r=await this.getInstitutionConfig(e);if(!r?.webhookSecret){console.error("No webhook secret configured for institution");return}if(!this.verifyWebhookSignature(JSON.stringify(s),t,r.webhookSecret)){console.error("Invalid webhook signature");return}if(s.entry&&s.entry.length>0){for(let t of s.entry)if(t.changes&&t.changes.length>0){for(let s of t.changes)if(s.value&&s.value.messages)for(let t of s.value.messages)await this.processIncomingMessage(e,t)}}}catch(e){console.error("Error handling webhook:",e)}}async processIncomingMessage(e,s){try{await this.logReminderMessage(e,s.from,s.text?.body||"Non-text message","whatsapp","received"),"text"===s.type&&await this.handleTextMessage(e,s)}catch(e){console.error("Error processing incoming message:",e)}}async handleTextMessage(e,s){let t=s.text.body.toLowerCase(),r=s.from;t.includes("fee")||t.includes("payment")?await this.sendTextMessage(e,r,"Thank you for your inquiry. Please contact the school office for fee-related queries."):(t.includes("receipt")||t.includes("bill"))&&await this.sendTextMessage(e,r,"Please provide your student ID or admission number to get your receipt details.")}formatPhoneNumber(e){let s=e.replace(/\D/g,"");return s.startsWith("91")||10!==s.length||(s="91"+s),s}async logReminderMessage(e,s,t,r,a,n,o){try{await this.supabase.from("reminder_logs").insert({institution_id:e,student_id:n,template_id:o,reminder_type:r,recipient_whatsapp:s,message_content:t,status:a,sent_at:"sent"===a?new Date().toISOString():null})}catch(e){console.error("Error logging reminder message:",e)}}}let n=new a}};var s=require("../../../../webpack-runtime.js");s.C(e);var t=e=>s(s.s=e),r=s.X(0,[638,720,256],()=>t(46139));module.exports=r})();